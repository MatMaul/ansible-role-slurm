---
    # We have to remove the entries in /etc/hosts that correspond to the node name
    - shell: cat /etc/hosts | sed "/{{slurm_server_name}}/d" > /tmp/newhosts  
    # Now we add a new entry with the new IP address
    - shell: echo "{{ slurm_server_ip }} {{ slurm_server_name }}" >> /tmp/newhosts 
    # Let's set the new /etc/hosts file
    - shell: cp /tmp/newhosts /etc/hosts && rm /tmp/newhosts 

    - local_action: wait_for path=/etc/munge/munge.key
      when: not munge_key.stat.exists
    - include: sudo_copy.yaml src=/etc/munge/munge.key dest=/etc/munge/munge.key owner=munge group=munge mode="0400"
      when: not munge_key.stat.exists
    - service: name=munge state=restarted
      when: not munge_key.stat.exists

    - lineinfile: dest={{ SLURM_CONF }} regexp='ControlMachine=' line='ControlMachine={{slurm_server_name}}'

    # A patch to solve some strange issue in CentOS 7
    - lineinfile: dest={{ SLURM_CONF }} regexp='^SlurmdPidFile=' line='SlurmdPidFile=/var/run/slurmctld.pid'
      when: ansible_distribution == "RedHat" and ansible_distribution_major_version == "7"

    # start SLURM daemon
    - service: name={{SLURM_SERVICE}} state=started

